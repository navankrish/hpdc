<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Navan's HPDC Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; }
    #chat { max-width: 600px; margin: 20px auto; background: white; padding: 10px; border-radius: 8px; height: 400px; overflow-y: auto; }
    .message { margin: 10px 0; clear: both; }
    .bot { color: white; background: #007bff; padding: 8px 12px; border-radius: 12px; display: inline-block; max-width: 80%; }
    .user { color: #333; background: #ddd; padding: 8px 12px; border-radius: 12px; display: inline-block; max-width: 80%; float: right; }
    #input-area { max-width: 600px; margin: 0 auto; display: flex; padding: 10px; }
    #userInput { flex-grow: 1; padding: 10px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; }
    #sendBtn, #downloadBtn { padding: 10px 20px; font-size: 16px; margin-left: 8px; cursor: pointer; border-radius: 6px; border: none; background: #007bff; color: white; }
    #downloadBtn { display: none; }
  </style>
</head>
<body>

<div id="chat"></div>

<div id="input-area">
  <input type="text" id="userInput" placeholder="Type your answer..." autocomplete="off" />
  <button id="sendBtn">Send</button>
  <button id="downloadBtn">Download PDF</button>
</div>

<script>
  const chat = document.getElementById('chat');
  const input = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  let data = {};
  let step = 0;
  let resultText = '';

  const steps = [
    { id: 'massShot', question: "Enter mass of shot in grams:" },
    { id: 'origin', question: "Enter origin length in mm:" },
    { id: 'castingWeight', question: "Enter casting weight in grams:" },
    { id: 'overflowWeight', question: "Enter overflow weight in grams:" },
    { id: 'plungerDia', question: "Enter plunger diameter in mm:" },
    { id: 'biscuitThickness', question: "Enter biscuit thickness in cm:" },
    { id: 'shotWeight', question: "Enter shot weight in grams:" },
    { id: 'gateLength', question: "Enter gate length in mm:" },
    { id: 'gateWidth', question: "Enter gate width in mm:" },
    { id: 'fastShotSpeed', question: "Enter fast shot speed in m/s:" },
    { id: 'injectionPressure', question: "Enter injection pressure in kg/cmÂ²:" },
    { id: 'pistonDia', question: "Enter piston diameter in cm:" },
    { id: 'tpaPartArea', question: "Enter part area in cmÂ²:" },
    { id: 'tpaOverflowArea', question: "Enter overflow area in cmÂ²:" },
    { id: 'tpaRunnerArea', question: "Enter runner area in cmÂ²:" },
  ];

  function addMessage(sender, text) {
    const div = document.createElement('div');
    div.classList.add('message');
    div.classList.add(sender === 'bot' ? 'bot' : 'user');
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function botAsk() {
    if (step < steps.length) {
      if (data[steps[step].id] !== undefined) {
        step++;
        botAsk();
      } else {
        addMessage('bot', steps[step].question);
      }
    } else {
      doCalculations();
    }
  }

  function userRespond() {
    const val = input.value.trim();
    if (!val) return;

    addMessage('user', val);
    const numVal = Number(val);
    data[steps[step].id] = !isNaN(numVal) ? numVal : val;
    input.value = '';
    step++;
    botAsk();
  }

  function doCalculations() {
    const originCm = data.origin / 10;
    const volumeAheadGate = (data.castingWeight + data.overflowWeight) / 2.67;
    const plungerRadiusCm = (data.plungerDia / 10) / 2;
    const plungerArea = Math.PI * plungerRadiusCm * plungerRadiusCm;

    data.shotVolume = (data.massShot / 2.67).toFixed(3);
    const L1 = volumeAheadGate / plungerArea;
    data.firstStrokeLength = (originCm - (L1 + data.biscuitThickness + 1 + 2.5)).toFixed(3);
    data.fillRatio = ((data.shotWeight) / (plungerArea * originCm * 2.67) * 100).toFixed(2);
    data.gateArea = ((data.gateLength / 10) * (data.gateWidth / 10)).toFixed(3);
    data.gateVelocity = ((plungerArea * data.fastShotSpeed) / data.gateArea).toFixed(3);
    const pistonArea = (Math.PI * data.pistonDia * data.pistonDia) / 4;
    data.castingPressure = (data.injectionPressure * (pistonArea / plungerArea)).toFixed(3);
    const fastShotSpeedCm = data.fastShotSpeed * 100; // Convert m/s to cm/s
    data.fillTime = (volumeAheadGate / (plungerArea * fastShotSpeedCm)).toFixed(3);
    data.totalProjectedArea = (data.tpaPartArea + data.tpaOverflowArea + data.tpaRunnerArea).toFixed(3);
    data.clampingForce = (data.totalProjectedArea * data.castingPressure).toFixed(3);
    data.machineTonnage = (data.clampingForce * 1.1).toFixed(3);

    resultText = `
Navan's HPDC Calculations

Shot Volume: ${data.shotVolume} cmÂ³
First Stroke Length: ${data.firstStrokeLength} cm
Fill Ratio: ${data.fillRatio}%
Gate Area: ${data.gateArea} cmÂ²
Gate Velocity: ${data.gateVelocity} cm/s
Casting Pressure: ${data.castingPressure} kg/cmÂ²
Fill Time: ${data.fillTime} s
Total Projected Area: ${data.totalProjectedArea} cmÂ²
Clamping Force Required: ${data.clampingForce} kg
Machine Tonnage Required: ${data.machineTonnage} kg
    `.trim();

    addMessage('bot', resultText.replace(/\n/g, '\n\n'));
    downloadBtn.style.display = 'inline-block';
  }

  async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const lines = resultText.split('\n');
    doc.setFontSize(12);
    lines.forEach((line, index) => {
      doc.text(line, 10, 10 + index * 8);
    });
    doc.save("Navans_HPDC_Calculations.pdf");
  }

  addMessage('bot', "ðŸ‘‹ Welcome to Navan's HPDC Calculator Chatbot!");
  botAsk();

  sendBtn.onclick = userRespond;
  input.addEventListener('keydown', e => { if (e.key === 'Enter') userRespond(); });
  downloadBtn.onclick = downloadPDF;
</script>

</body>
</html>
